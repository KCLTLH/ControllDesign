close all, clear all% Drive motor and drive motor amplifier parametersK1 = 99e-3;     % Motor constant (V/(rad/sec))R1 = 2.13;      % Armature resistance (ohms)Dm1 = 1.27e-4;  % Motor damping constant (N*m/(rad/sec))L1 = 0.686e-3;  % Armature inductance (H)Jm1 = 26.9e-6;  % Motor inertia (kg*m^2)Ka1 = 32.2;     % Gain of amplifier gain for drive motor (V/V)Ra1 = 0.2;      % Resistance of amplifier for drive motor (ohms)% Load motor and load motor amplifier parametersK2 = 62e-3;     % Motor constant (V/(rad/sec))R2 = 1.2;       % Armature resistance (ohms)Dm2 = 60e-6;    % Motor damping constant (N*m/(rad/sec))L2 = 2.1e-3;    % Armature inductance (H)Jm2 = 24.38e-6; % Motor inertia (kg*m^2)Ka2 = 32.2;     % Amplifier gain for drive motor (V/V)Ra2 = 0.2;      % Amplifier resistance for drive motor (ohms)% Other parametersJ1 = 1.25e-3;   % Inertial load on theta1 shaft (kg*m^2)J2 = 1.0e-3;    % Inertial load on theta2 shaft (kg*m^2)D1 = 42.35e-6;  % Viscous friction coefficient for theta1 shaft(N*m/(rad/sec))D2 = 42.35e-6;  % Viscous friction coefficient for theta2 shaft (N*m/(rad/sec))n = 5.0;        % Gear ratioKs = 100;       % Shaft stiffness (N*m/rad)% Generate State Model MatricesJeq1 = J1 + n^2*Jm1;Jeq2 = J2 + Jm2;Deq1 = D1 + n^2*Dm1;Deq2 = D2 + Dm2;a11 = -(Ra1+R1)/L1;a14 = -n*K1/L1;a22 = -(Ra2 + R2)/L2;a26 = -K2/L2;a41 = n*K1/Jeq1;a43 = -Ks/Jeq1;a44 = -Deq1/Jeq1;a45 = Ks/Jeq1;a62 = K2/Jeq2;a63 = Ks/Jeq2;a65 = -Ks/Jeq2;a66 = -Deq2/Jeq2;b11 = Ka1/L1;b22 = Ka2/L2;A = [a11       0        0      a14       0        0       0     a22        0        0       0      a26       0       0        0        1       0        0     a41       0      a43      a44     a45        0       0       0        0        0       0        1       0     a62      a63        0     a65      a66];B = [b11     0       0   b22       0     0       0     0       0     0       0     0];C = [0 0 1 0 0 0    0 0 0 0 1 0];D = [0 0    0 0];%% Step 1figure()Ts = 0.02;P_s = ss(A,B,C,D);P_z =c2d(P_s,Ts);e12theda2 = P_z(2,1);bode(P_z(2,1))grid on ,hold onbode(P_s(2,1))legend('Discrete-time (T = 0.2sec)', 'Continuous-time')xlim([1, 10^3])title('Bode of Open-Loop Plant e1 to theta2 Transfer Function')%% Step 2 With proportition controlfigure()K = 0.66861;K_z = tf(K, 1, Ts);bode(K_z * e12theda2)grid on ,hold on%% lead compensatorfigure()wz = 18.765;wp = 52.596;LEAD_S = sqrt(wp/wz)* tf([1, wz], [1 , wp]);LEAD_Z = c2d(LEAD_S, Ts, 'tustin');bode(LEAD_Z)grid on ,hold on%% ADD LEAD PROP. Compensatorfigure()LKP_Z = K_z*LEAD_Z*e12theda2;bode(e12theda2)grid on ,hold onbode(K_z * e12theda2)bode(LKP_Z)legend('Origin plant', 'Prop. Control', 'ADD P, LEAD')title('Comparision')hold off%% CLTF CHECK BW theda2/theda2_reffigure()CLTF_Z = feedback(LKP_Z, 1);bode(CLTF_Z)grid on, hold on e22theda2 = P_z(2,2);bode(feedback(e22theda2, K_z*LEAD_Z))legend('theda2/theda2_ref', 'theda2/e2')title('Bode of Close-Loop Transfer Functions With Lead Compensation')%% LAG Compensatorfigure()LAG_s = tf([1, 2.6], [1, 0]);LAG_z = c2d(LAG_s, Ts, 'tustin');bode(LAG_z)grid onlegend('Discrete Time')%% Show Lead-Lagfigure()LLK_Z = LAG_z*K_z*LEAD_Z;bode(LLK_Z)title('Bode of Lead-Lag Compensators')grid on%% Bode loop transfer functionfigure()bode(LAG_z*K_z*LEAD_Z*e12theda2)grid on, hold onbode(K_z*LEAD_Z*e12theda2)hold offtitle('Bode of Loop Transfer Function with Lead-Lag Compensation')legend('Lead_Lag', 'Lead')%% Combine with systemfigure()CLTF_LLKP_Z = feedback(LAG_z*K_z*LEAD_Z*e12theda2, 1);bode(CLTF_LLKP_Z)grid on, hold onCLTF_LLKP_Ze2 = feedback(e22theda2, LAG_z*K_z*LEAD_Z);bode(CLTF_LLKP_Ze2)legend('theda2/theda2_ref')title('Bode of Close-Loop Transfer Function with Lead-Lag Compensation')%% y_ref step inputfigure()CLTF_LLKP_Ztheda1 = feedback(LAG_z*K_z*LEAD_Z*P_z(1,1), 1);[y2, t2] = step(CLTF_LLKP_Ztheda1,2);plot(t2, y2, '*', 'Color', 'blue')grid on, hold on[y1, t1] = step(CLTF_LLKP_Z,2);plot(t1, y1, '*', 'Color', 'red')plot(linspace(0,2), 1.02*ones(length(linspace(0,2))), 'g--')plot(linspace(0,2), 0.98*ones(length(linspace(0,2))), 'g--')legend('theda1', 'theda2')title('Response to theda2ref Step with LeadLag Compensation')%% e2 Step input and theda2ref is zerofigure()CLTF_LLKP_Ze2theda2 = feedback(P_z(2,2), LAG_z*K_z*LEAD_Z);CLTF_LLKP_Ze2theda1 = feedback(P_z(1,2), LAG_z*K_z*LEAD_Z);[y2, t2] = step(CLTF_LLKP_Ze2theda2,10);plot(t2, y2, '*', 'Color', 'blue')grid on, hold on[y1, t1] = step(CLTF_LLKP_Ze2theda1,10);plot(t1, y1, '*', 'Color', 'red')plot(linspace(0,2), 0*ones(length(linspace(0,2))), 'b--', MarkerSize=5)legend('theda1', 'theda2')title('Response to e2 Step with LeadLag Compensation')